{% extends "base.html" %}

{% block title %}KUSIS - 새 게시물 작성{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/create_post.css') }}">

{% endblock %}

{% block content %}
<div class="content-area create-post-page">
    <div class="create-post-container">
        <div class="page-header">
            <h3><i class="fas fa-pencil-alt"></i> 새 게시물 작성</h3>
            <a href="{{ url_for('post_management') }}" class="btn btn-secondary">
                <i class="fas fa-list"></i> 목록으로
            </a>
        </div>

        {# 플래시 메시지 (기존 유지) #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('create_post') }}" id="createPostForm" enctype="multipart/form-data">
            <div class="form-grid">
                {# --- 좌측: 입력 폼 --- #}
                <div class="form-left-column">
                    <div class="input-group">
                        <label for="title"><i class="fas fa-heading"></i> 제목</label>
                        <input type="text" id="title" name="title" required placeholder="게시물 제목을 입력하세요" value="{{ title or '' }}">
                    </div>

                    <div class="input-group">
                        <label for="category"><i class="fas fa-tags"></i> 카테고리</label>
                        <select id="category" name="category" required>
                            {% for cat in categories %}
                                <option value="{{ cat }}" {% if category == cat %}selected{% endif %}>{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="content"><i class="fas fa-paragraph"></i> 내용</label>
                        <textarea id="content" name="content" rows="10" required placeholder="게시물 내용을 입력하세요">{{ content or '' }}</textarea>
                    </div>

                    {# --- [수정] 이미지 첨부 UI/UX 개선 --- #}
                    <div class="input-group">
                        <label for="imageUpload"><i class="fas fa-images"></i> 이미지 첨부 (최대 {{ config.MAX_IMAGE_UPLOADS }}개)</label>
                        
                        {# [수정] multiple 추가, name="images"로 변경 #}
                        <input type="file" id="imageUpload" name="images" accept="image/*" multiple data-max-images="{{ config.MAX_IMAGE_UPLOADS }}">
                        
                        <small class="form-text">이미지 파일(jpg, png, gif 등)을 선택하세요. 최대 {{ config.MAX_IMAGE_UPLOADS }}개까지 첨부 가능합니다.</small>
                        
                        {# [신규] 이미지 제한 경고 메시지 #}
                        <small id="imageLimitMessage" class="image-limit-message">
                            이미지는 최대 {{ config.MAX_IMAGE_UPLOADS }}개까지만 첨부 가능합니다. 초과된 파일은 제외됩니다.
                        </small>

                        {# [신규] 이미지 미리보기 컨테이너 (그리드) #}
                        <div class="image-preview-container">
                            <label class="image-preview-label">첨부할 이미지 미리보기</label>
                            <div id="imagePreviewGrid" class="image-preview-grid">
                                {# JS에 의해 동적으로 채워짐 #}
                            </div>
                            <span id="noImageText" class="visible">첨부된 이미지가 없습니다.</span>
                        </div>
                    </div>
                    {# --- 이미지 첨부 수정 끝 --- #}


                    <div class="input-group">
                        <label for="expires_at"><i class="far fa-calendar-times"></i> 알림 노출 기한 (선택)</label>
                        <input type="datetime-local" id="expires_at" name="expires_at" value="{{ expires_at or '' }}">
                        <small class="form-text">설정하지 않으면 계속 노출됩니다. 설정된 시간 이후에는 알림 목록에서 자동으로 제거됩니다.</small>
                    </div>

                    <div class="input-group checkbox-group">
                        <input type="checkbox" id="is_notice" name="is_notice" {% if is_notice %}checked{% endif %}>
                        <label for="is_notice">상단 알림 위젯에 공지사항으로 표시 (관리자 승인 필요)</label>
                    </div>
                </div>

                {# --- 우측: 미리보기 (기존 유지) --- #}
                <div class="form-right-column">
                    <h4><i class="fas fa-eye"></i> 미리보기</h4>
                    <div class="preview-container">
                        <h1 id="previewTitle" class="preview-title">제목이 여기에 표시됩니다</h1>
                        <div id="previewContent" class="preview-content">
                            <p>내용이 여기에 표시됩니다.</p>
                            {# [수정] 이미지 관련 텍스트 제거 -> JS로 내용 변환 #}
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-submit-post">
                    <i class="fas fa-check"></i> 작성 완료
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script src="{{ url_for('static', filename='js/create_post.js') }}"></script>
{% endblock %}