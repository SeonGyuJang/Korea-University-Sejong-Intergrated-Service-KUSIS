{% extends "base.html" %}

{% block title %}KUSIS - 공부 분석{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/study_analysis.css') }}">
{% endblock %}

{% block content %}
<div class="content-area study-analysis-page">
    {# --- 페이지 헤더 --- #}
    <div class="page-header">
        <h1><i class="fas fa-chart-line"></i> 공부 분석</h1>
        {# 학기 선택 (시간표 관리와 연동) #}
        <select id="studyAnalysisSemesterSelect" class="input-group semester-select-study">
            <option value="">학기 로딩 중...</option>
        </select>
    </div>

    <div class="study-analysis-container">
        {# --- 좌측: 통계 및 그래프 --- #}
        <div class="analysis-main-column">
            {# --- 기간 선택 탭 --- #}
            <div class="period-tabs widget-tabs">
                <button class="tab active" data-period="daily">일간</button>
                <button class="tab" data-period="weekly">주간</button>
                <button class="tab" data-period="monthly">월간</button>
            </div>

            {# --- 총 공부 시간 및 날짜 표시 --- #}
            <div class="widget total-study-widget">
                <div class="total-time-header">
                    <h3 id="currentTimePeriod">오늘 총 공부 시간</h3>
                    <div id="dateNavigation" style="display: none;">
                        <button id="prevPeriodBtn" class="btn-sm"><i class="fas fa-chevron-left"></i></button>
                        <span id="currentDateDisplay"></span>
                        <button id="nextPeriodBtn" class="btn-sm"><i class="fas fa-chevron-right"></i></button>
                         <button id="todayPeriodBtn" class="btn-sm" style="margin-left: 5px;">오늘</button>
                    </div>
                </div>
                <div class="total-time-display">
                    <span id="totalStudyTime">0h 0m</span>
                </div>
                 {# --- 공부 펫 시스템 (Gamification) --- #}
                 <div class="study-pet-widget">
                    <div class="pet-header">
                        <h4><i class="fas fa-paw"></i> <span id="petNameDisplay">공부친구</span></h4>
                        <button id="petSettingsBtn" class="btn-icon" title="펫 설정"><i class="fas fa-cog"></i></button>
                    </div>
                    <div class="pet-container" id="studyPetContainer">
                        <div class="pet-image-wrapper">
                            <img id="studyPetImage" src="{{ url_for('static', filename='images/pet_cat_lv1.png') }}" alt="공부 펫">
                            <div class="pet-level-badge" id="petLevelBadge">Lv. 1</div>
                        </div>
                        <div class="pet-health-bar">
                            <div class="health-bar-fill" id="petHealthFill" style="width: 100%;"></div>
                        </div>
                        <div class="pet-stats">
                            <div class="stat-item">
                                <span class="stat-label">건강도</span>
                                <span class="stat-value" id="petHealthValue">100%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">감정</span>
                                <span class="stat-value" id="petMoodValue">😊 행복</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">연속 공부</span>
                                <span class="stat-value" id="petStreakValue">0일</span>
                            </div>
                        </div>
                        <div class="pet-exp-bar">
                            <div class="exp-bar-fill" id="petExpFill" style="width: 0%;"></div>
                            <span class="exp-text" id="petExpText">EXP 0%</span>
                        </div>
                    </div>
                    <p class="pet-message" id="petMessage">공부해서 펫을 키워보세요!</p>
                    <div class="pet-badges" id="petBadges"></div>
                </div>
            </div>

            {# --- 메인 공부 시간 그래프 --- #}
            <div class="widget chart-widget">
                <div class="widget-header">
                    <h3 id="chartTitle"><i class="fas fa-chart-bar"></i> 시간별 공부 기록</h3>
                </div>
                <div class="chart-container">
                    <canvas id="studyTimeChart"></canvas>
                </div>
            </div>
        </div>

        {# --- 우측: 과목별 기록 및 타이머 --- #}
        <div class="analysis-side-column">
            {# --- 과목별 타이머 --- #}
            <div class="widget subject-timer-widget">
                <div class="widget-header">
                    <h3><i class="fas fa-stopwatch"></i> 과목별 시간 측정</h3>
                </div>
                <div class="input-group">
                    <label for="subjectSelectTimer">과목 선택</label>
                    <select id="subjectSelectTimer" disabled>
                        <option value="">과목 로딩 중...</option>
                    </select>
                </div>
                <div class="subject-timer-display">
                    <span id="subjectTimerDisplay">00:00:00</span>
                </div>
                <div class="subject-timer-controls">
                    <button id="startSubjectTimerBtn" class="btn btn-primary" disabled><i class="fas fa-play"></i> 시작</button>
                    <button id="stopSubjectTimerBtn" class="btn btn-danger" disabled><i class="fas fa-stop"></i> 중지</button>
                </div>
                <small id="currentTimingSubject" class="timing-info"></small>
            </div>

            {# --- 과목별 공부 시간 분포 --- #}
            <div class="widget subject-distribution-widget">
                <div class="widget-header">
                    <h3 id="subjectDistTitle"><i class="fas fa-pie-chart"></i> 오늘 과목별 분포</h3>
                </div>
                <div class="subject-chart-container">
                    <canvas id="subjectDistributionChart"></canvas>
                    <div id="subjectListContainer">
                        <ul id="subjectStudyList">
                            <li class="no-data">데이터 없음</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# --- 펫 설정 모달 --- #}
    <div id="petSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>펫 설정</h3>
                <button class="modal-close" id="closePetModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="petNameInput">펫 이름</label>
                    <input type="text" id="petNameInput" class="form-control" placeholder="공부친구" maxlength="50">
                </div>
                <div class="form-group">
                    <label>펫 종류</label>
                    <div class="pet-type-selector">
                        <button class="pet-type-btn" data-type="cat">
                            <i class="fas fa-cat"></i>
                            <span>고양이</span>
                        </button>
                        <button class="pet-type-btn" data-type="dog">
                            <i class="fas fa-dog"></i>
                            <span>강아지</span>
                        </button>
                        <button class="pet-type-btn" data-type="rabbit">
                            <i class="fas fa-dove"></i>
                            <span>토끼</span>
                        </button>
                        <button class="pet-type-btn" data-type="bird">
                            <i class="fas fa-feather"></i>
                            <span>새</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelPetSettings">취소</button>
                <button class="btn btn-primary" id="savePetSettings">저장</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
{# --- [수정] base.html에서 스크립트가 로드되므로 여기서는 중복 로드 제거 --- #}
<script src="{{ url_for('static', filename='js/study_analysis.js') }}"></script>
{% endblock %}