{# templates/edit_post.html #}
{% extends "base.html" %}

{% block title %}KUSIS - 게시물 수정{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/create_post.css') }}"> {# 생성 폼 CSS 재사용 #}
<style>
    /* --- 기존 이미지 표시 스타일 --- */
    .current-images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* 반응형 그리드 */
        gap: 10px;
        margin-top: 15px;
        border: 1px dashed var(--border-color);
        padding: 15px;
        border-radius: 8px;
        background: #fdfafb;
    }
    .current-image-item {
        position: relative;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        overflow: hidden;
    }
    .current-image-item img {
        display: block;
        width: 100%;
        height: 100px; /* 고정 높이 */
        object-fit: cover; /* 비율 유지하며 채우기 */
    }
    .current-image-item .delete-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .current-image-item input[type="checkbox"]:checked ~ .delete-overlay {
        opacity: 1; /* 체크 시 오버레이 표시 */
    }
     .current-image-item input[type="checkbox"] {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 18px; /* 체크박스 크기 */
        height: 18px;
        cursor: pointer;
        z-index: 10; /* 이미지 위에 오도록 */
    }
    .delete-overlay span {
        font-weight: bold;
        color: var(--color-danger);
        font-size: 12px;
    }
    .current-images-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: block;
    }

    /* --- 새 이미지 미리보기 스타일 --- */
    #newImagePreviewContainer {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 10px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed var(--border-color);
    }
    .new-preview-item {
        position: relative; /* 필요 시 삭제 버튼 등 추가 가능 */
        border: 1px solid var(--border-color);
        border-radius: 4px;
        overflow: hidden;
    }
    .new-preview-item img {
        display: block;
        width: 100%;
        height: 100px;
        object-fit: cover;
    }
    .image-limit-message {
        font-size: 12px;
        color: var(--color-danger);
        margin-top: 5px;
        display: none; /* 초기 숨김 */
    }
</style>
{% endblock %}

{% block content %}
<div class="content-area create-post-page">
    <div class="create-post-container">
        <div class="page-header">
            <h3><i class="fas fa-edit"></i> 게시물 수정</h3>
            <a href="{{ url_for('view_post', post_id=post.id) }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> 게시물 보기
            </a>
        </div>

        {# 플래시 메시지 (기존 유지) #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {# --- form enctype 수정 --- #}
        <form method="POST" action="{{ url_for('edit_post', post_id=post.id) }}" id="editPostForm" enctype="multipart/form-data">
            <div class="form-grid">
                {# --- 좌측: 입력 폼 --- #}
                <div class="form-left-column">
                    {# 제목, 카테고리, 내용 (기존 유지) #}
                     <div class="input-group">
                        <label for="title"><i class="fas fa-heading"></i> 제목</label>
                        <input type="text" id="title" name="title" required value="{{ title or post.title }}">
                    </div>

                    <div class="input-group">
                        <label for="category"><i class="fas fa-tags"></i> 카테고리</label>
                        <select id="category" name="category" required>
                            {% for cat in categories %}
                                <option value="{{ cat }}" {% if (category or post.category) == cat %}selected{% endif %}>{{ cat }}</option> {# 수정: category 변수 없을 때 post.category 사용 #}
                            {% endfor %}
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="content"><i class="fas fa-paragraph"></i> 내용</label>
                        {# 수정: content 변수 없을 때 post.content 사용 #}
                        <textarea id="content" name="content" rows="10" required>{{ content or post.content.replace('<br>', '\n') }}</textarea>
                    </div>

                    {# --- 이미지 관리 --- #}
                    <div class="input-group">
                        <label for="imageUpload"><i class="fas fa-images"></i> 이미지 추가 (최대 {{ config.MAX_IMAGE_UPLOADS }}개)</label>
                        {# --- multiple 속성 추가, name 변경 --- #}
                        <input type="file" id="imageUpload" name="images" accept="image/*" multiple>
                        <small class="form-text">새 이미지를 추가할 수 있습니다. 기존 이미지와 합쳐 최대 {{ config.MAX_IMAGE_UPLOADS }}개까지 가능합니다.</small>
                        <small id="imageLimitMessage" class="image-limit-message">이미지는 최대 {{ config.MAX_IMAGE_UPLOADS }}개까지만 첨부 가능합니다.</small>

                        {# --- 기존 이미지 표시 및 삭제 --- #}
                        {% if existing_images %}
                        <div id="currentImagesContainer">
                            <label class="current-images-label">현재 이미지 (삭제하려면 체크)</label>
                            <div class="current-images-grid">
                                {% for filename in existing_images %}
                                <div class="current-image-item">
                                    <img src="{{ url_for('uploaded_file', filename=filename) }}" alt="현재 이미지 {{ loop.index }}">
                                    {# --- name="delete_images", value=filename --- #}
                                    <input type="checkbox" name="delete_images" value="{{ filename }}" title="삭제 체크">
                                    <div class="delete-overlay"><span>삭제 예정</span></div>
                                </div>
                                {% endfor %}
                            </div>
                         </div>
                        {% endif %}

                        {# --- 새 이미지 미리보기 컨테이너 --- #}
                        <div id="newImagePreviewContainer">
                            </div>
                    </div>
                    {# --- 이미지 관리 끝 --- #}


                    {# 노출 기한, 공지 체크박스 (기존 유지) #}
                    <div class="input-group">
                        <label for="expires_at"><i class="far fa-calendar-times"></i> 알림 노출 기한 (선택, KST)</label>
                        {# 수정: expires_at 변수 없을 때 post.expires_at 사용 (포맷팅은 서버에서) #}
                        <input type="datetime-local" id="expires_at" name="expires_at" value="{{ expires_at }}">
                        <small class="form-text">한국 시간(KST) 기준. 비워두면 계속 노출됩니다.</small>
                    </div>

                    <div class="input-group checkbox-group">
                         {# 수정: is_notice 변수 없을 때 post.is_notice 사용 #}
                        <input type="checkbox" id="is_notice" name="is_notice" {% if is_notice or post.is_notice %}checked{% endif %}>
                        <label for="is_notice">상단 알림 위젯에 공지사항으로 표시 (관리자 승인 필요)</label>
                    </div>
                </div>

                {# --- 우측: 미리보기 --- #}
                <div class="form-right-column">
                    <h4><i class="fas fa-eye"></i> 미리보기</h4>
                    <div class="preview-container">
                        {# 수정: title 변수 없을 때 post.title 사용 #}
                        <h1 id="previewTitle" class="preview-title">{{ title or post.title }}</h1>
                        <div id="previewContent" class="preview-content {% if post.image_filenames %}has-image{% endif %}">
                             {# 수정: content 변수 없을 때 post.content 사용, safe 필터 추가 #}
                             {{ (content or post.content) | safe }}
                             {# 이미지 관련 텍스트는 JS에서 관리하므로 제거 #}
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <a href="{{ url_for('view_post', post_id=post.id) }}" class="btn btn-secondary" style="margin-right: 10px;">취소</a>
                <button type="submit" class="btn btn-primary btn-submit-post">
                    <i class="fas fa-save"></i> 수정 완료
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // 미리보기 업데이트 로직
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content');
    const previewTitle = document.getElementById('previewTitle');
    const previewContent = document.getElementById('previewContent');

    function updateTextPreview() {
        if (previewTitle) previewTitle.textContent = titleInput.value.trim() || '제목이 여기에 표시됩니다';
        if (previewContent) {
            // HTML 태그가 포함될 수 있으므로 textContent 대신 innerHTML 사용 (XSS 주의 필요하나, 여기서는 사용자가 입력한 내용 미리보기이므로 허용)
             // \n -> <br> 변환은 서버에서 하므로 여기서는 불필요
            previewContent.innerHTML = contentInput.value || '<p>내용이 여기에 표시됩니다.</p>';
        }
    }

    if (titleInput) titleInput.addEventListener('input', updateTextPreview);
    if (contentInput) contentInput.addEventListener('input', updateTextPreview);

    // --- 이미지 관련 JS ---
    const imageInput = document.getElementById('imageUpload');
    const newImagePreviewContainer = document.getElementById('newImagePreviewContainer');
    const currentImagesContainer = document.getElementById('currentImagesContainer');
    const imageLimitMessage = document.getElementById('imageLimitMessage');
    const MAX_IMAGES = parseInt("{{ config.MAX_IMAGE_UPLOADS }}", 10) || 3; // 설정값 가져오기

    // 현재 이미지 개수 계산 (삭제 체크 안 된 것)
    function getCurrentVisibleImageCount() {
        if (!currentImagesContainer) return 0;
        const checkboxes = currentImagesContainer.querySelectorAll('input[name="delete_images"]');
        let count = 0;
        checkboxes.forEach(cb => {
            if (!cb.checked) {
                count++;
            }
        });
        return count;
    }

    // 새 이미지 미리보기 처리 함수
    function handleImagePreview(event) {
        if (!newImagePreviewContainer || !imageLimitMessage) return;

        const files = event.target.files;
        newImagePreviewContainer.innerHTML = ''; // 미리보기 초기화
        imageLimitMessage.style.display = 'none'; // 경고 메시지 숨김

        let currentVisibleCount = getCurrentVisibleImageCount();
        let newFilesToPreview = Array.from(files);

        // 이미지 개수 제한 검사
        if (currentVisibleCount + newFilesToPreview.length > MAX_IMAGES) {
            imageLimitMessage.style.display = 'block';
            // 허용 개수만큼만 잘라서 미리보기
            newFilesToPreview = newFilesToPreview.slice(0, MAX_IMAGES - currentVisibleCount);
            // 입력 파일 자체를 제한할 수는 없지만, 사용자에게 알림
             alert(`이미지는 최대 ${MAX_IMAGES}개까지 첨부 가능합니다. 초과된 파일은 제외됩니다.`);
             // 실제 파일 목록을 잘라낼 수는 없으므로, 서버 측에서 최종 검증 필요
        }

        // 새 이미지 미리보기 생성
        newFilesToPreview.forEach(file => {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.classList.add('new-preview-item');
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = "새 이미지 미리보기";
                    previewItem.appendChild(img);
                    newImagePreviewContainer.appendChild(previewItem);
                }
                reader.readAsDataURL(file);
            }
        });

        // 새 파일 선택 시 기존 이미지 컨테이너 숨기기/보이기 (선택적)
        if (newFilesToPreview.length > 0 && currentImagesContainer) {
            // currentImagesContainer.style.display = 'none'; // 숨기거나
            // 아니면 그냥 두거나
        } else if (currentImagesContainer) {
            // currentImagesContainer.style.display = 'block'; // 다시 보이게
        }
    }

    // 기존 이미지 삭제 체크박스 이벤트 처리
    if (currentImagesContainer) {
        currentImagesContainer.addEventListener('change', (event) => {
            if (event.target.type === 'checkbox' && event.target.name === 'delete_images') {
                 // 삭제 체크/해제 시 새 이미지 미리보기 업데이트 (개수 제한 때문)
                 handleImagePreview({ target: imageInput }); // imageInput의 현재 파일 목록으로 다시 그림
                 // 시각적 피드백 (이미 적용됨: 체크 시 오버레이)
            }
        });
    }

    if (imageInput) imageInput.addEventListener('change', handleImagePreview);

    // 초기 미리보기 실행
    updateTextPreview();
    // 페이지 로드 시 기존 파일 상태 반영 (handleImagePreview 호출)
    handleImagePreview({ target: imageInput });

});
</script>
{% endblock %}