{# templates/edit_post.html #}
{% extends "base.html" %}

{% block title %}KUSIS - 게시물 수정{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/create_post.css') }}"> {# 생성 폼 CSS 재사용 #}

{% endblock %}

{% block content %}
<div class="content-area create-post-page">
    <div class="create-post-container">
        <div class="page-header">
            <h3><i class="fas fa-edit"></i> 게시물 수정</h3>
            <a href="{{ url_for('view_post', post_id=post.id) }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> 게시물 보기
            </a>
        </div>

        {# 플래시 메시지 (기존 유지) #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {# --- form enctype 수정 (기존 유지) --- #}
        <form method="POST" action="{{ url_for('edit_post', post_id=post.id) }}" id="editPostForm" enctype="multipart/form-data">
            <div class="form-grid">
                {# --- 좌측: 입력 폼 --- #}
                <div class="form-left-column">
                    {# 제목, 카테고리, 내용 (기존 유지) #}
                     <div class="input-group">
                        <label for="title"><i class="fas fa-heading"></i> 제목</label>
                        <input type="text" id="title" name="title" required value="{{ title or post.title }}">
                    </div>

                    <div class="input-group">
                        <label for="category"><i class="fas fa-tags"></i> 카테고리</label>
                        <select id="category" name="category" required>
                            {% for cat in categories %}
                                <option value="{{ cat }}" {% if (category or post.category) == cat %}selected{% endif %}>{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="content"><i class="fas fa-paragraph"></i> 내용</label>
                        <textarea id="content" name="content" rows="10" required>{{ content or post.content.replace('<br>', '\n') }}</textarea>
                    </div>

                    {# --- [수정] 이미지 관리 UI/UX 개선 --- #}
                    <div class="input-group">
                        <label for="imageUpload"><i class="fas fa-images"></i> 이미지 관리 (최대 {{ config.MAX_IMAGE_UPLOADS }}개)</label>
                        
                        {# --- 기존 이미지 표시 및 삭제 UI 개선 --- #}
                        {% if existing_images %}
                        <div class="image-preview-container" id="currentImagesContainer">
                            <label class="image-preview-label">현재 이미지 (삭제하려면 체크)</label>
                            <div class="image-preview-grid">
                                {% for filename in existing_images %}
                                {# [수정] UI 개선된 아이템 구조 #}
                                <div class="image-preview-item current-image-item">
                                    <img src="{{ url_for('uploaded_file', filename=filename) }}" alt="현재 이미지 {{ loop.index }}">
                                    <div class="delete-checkbox-wrapper">
                                        <input type="checkbox" name="delete_images" value="{{ filename }}" id="del_img_{{ loop.index }}" class="delete-image-cb">
                                        <label for="del_img_{{ loop.index }}">삭제</label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                         </div>
                        {% endif %}

                        {# --- 새 이미지 추가 --- #}
                        <label for="imageUpload" style="margin-top: 15px;"><i class="fas fa-plus-circle"></i> 새 이미지 추가</label>
                        <input type="file" id="imageUpload" name="images" accept="image/*" multiple>
                        <small class="form-text">새 이미지를 추가할 수 있습니다. (기존 이미지 포함 최대 {{ config.MAX_IMAGE_UPLOADS }}개)</small>
                        <small id="imageLimitMessage" class="image-limit-message">
                            이미지는 최대 {{ config.MAX_IMAGE_UPLOADS }}개까지 첨부 가능합니다. 초과된 파일은 제외됩니다.
                        </small>
                        
                        {# --- 새 이미지 미리보기 (create_post와 동일한 구조) --- #}
                        <div class="image-preview-container" style="margin-top: 10px;">
                            <label class="image-preview-label">새로 추가할 이미지 미리보기</label>
                            <div id="newImagePreviewGrid" class="image-preview-grid">
                                {# JS에 의해 동적으로 채워짐 #}
                            </div>
                            <span id="noNewImageText" class="visible">추가할 이미지가 없습니다.</span>
                        </div>
                    </div>
                    {# --- 이미지 관리 끝 --- #}


                    {# 노출 기한, 공지 체크박스 (기존 유지) #}
                    <div class="input-group">
                        <label for="expires_at"><i class="far fa-calendar-times"></i> 알림 노출 기한 (선택, KST)</label>
                        <input type="datetime-local" id="expires_at" name="expires_at" value="{{ expires_at }}">
                        <small class="form-text">한국 시간(KST) 기준. 비워두면 계속 노출됩니다.</small>
                    </div>

                    <div class="input-group checkbox-group">
                        <input type="checkbox" id="is_notice" name="is_notice" {% if is_notice is defined %}{% if is_notice %}checked{% endif %}{% elif post.is_notice %}checked{% endif %}>
                        <label for="is_notice">상단 알림 위젯에 공지사항으로 표시 (관리자 승인 필요)</label>
                    </div>
                </div>

                {# --- 우측: 미리보기 --- #}
                <div class="form-right-column">
                    <h4><i class="fas fa-eye"></i> 미리보기</h4>
                    <div class="preview-container">
                        <h1 id="previewTitle" class="preview-title">{{ title or post.title }}</h1>
                        {# [수정] <br> 변환을 JS에서 처리하도록 변경, |safe 제거 #}
                        <div id="previewContent" class="preview-content">
                            {{ content or post.content.replace('<br>', '\n') }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <a href="{{ url_for('view_post', post_id=post.id) }}" class="btn btn-secondary" style="margin-right: 10px;">취소</a>
                <button type="submit" class="btn btn-primary btn-submit-post">
                    <i class="fas fa-save"></i> 수정 완료
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 텍스트 미리보기 로직 ---
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content');
    const previewTitle = document.getElementById('previewTitle');
    const previewContent = document.getElementById('previewContent');

    function updateTextPreview() {
        if (previewTitle) {
            previewTitle.textContent = titleInput.value.trim() || '제목이 여기에 표시됩니다';
        }
        if (previewContent) {
            // [수정] \n을 <br>로 변환하여 미리보기에 즉시 반영
            const contentHtml = contentInput.value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .replace(/\n/g, '<br>');
            previewContent.innerHTML = contentHtml || '<p>내용이 여기에 표시됩니다.</p>';
        }
    }

    if (titleInput) titleInput.addEventListener('input', updateTextPreview);
    if (contentInput) contentInput.addEventListener('input', updateTextPreview);
    
    // 초기 로드 시 텍스트 미리보기 실행
    updateTextPreview();

    // --- [신규] 이미지 관리 로직 (UI/UX 개선) ---
    const imageInput = document.getElementById('imageUpload');
    const newPreviewGrid = document.getElementById('newImagePreviewGrid');
    const noNewImageText = document.getElementById('noNewImageText');
    const limitMessage = document.getElementById('imageLimitMessage');
    const deleteCheckboxes = document.querySelectorAll('.delete-image-cb');
    const MAX_IMAGES = parseInt("{{ config.MAX_IMAGE_UPLOADS }}", 10) || 3;

    // 현재 유지될 (삭제 체크 안 된) 기존 이미지 개수 계산
    function getCurrentVisibleImageCount() {
        let count = 0;
        deleteCheckboxes.forEach(cb => {
            if (!cb.checked) {
                count++;
            }
        });
        return count;
    }

    // 새 이미지 미리보기 처리 함수
    function handleNewImagePreview(event) {
        // 1. 상태 초기화
        newPreviewGrid.innerHTML = '';
        limitMessage.classList.remove('visible');
        noNewImageText.classList.remove('visible');

        let files = Array.from(event.target.files);
        let currentVisibleCount = getCurrentVisibleImageCount();
        const availableSlots = MAX_IMAGES - currentVisibleCount;

        // 2. 이미지 개수 제한 검사
        if (files.length > availableSlots) {
            limitMessage.classList.add('visible');
            // 허용된 개수만큼 파일 배열을 자름
            files = files.slice(0, availableSlots);
        }

        // 3. 파일이 없는 경우
        if (files.length === 0) {
            noNewImageText.classList.add('visible');
            return;
        }

        // 4. 선택된 파일 미리보기 생성
        files.forEach(file => {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const item = document.createElement('div');
                    item.classList.add('image-preview-item');
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = file.name;
                    
                    const filename = document.createElement('span');
                    filename.classList.add('image-filename');
                    filename.textContent = file.name;

                    item.appendChild(img);
                    item.appendChild(filename);
                    newPreviewGrid.appendChild(item);
                }
                
                reader.readAsDataURL(file);
            }
        });
    }

    // 파일 입력 시 이벤트 리스너
    if (imageInput && newPreviewGrid && noNewImageText && limitMessage) {
        imageInput.addEventListener('change', handleNewImagePreview);
    }

    // 기존 이미지 삭제 체크박스 클릭 시 이벤트 리스너
    // (삭제 체크/해제 시 새 이미지 업로드 가능 개수가 달라지므로 미리보기를 다시 그림)
    deleteCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            // 새 이미지 파일 입력을 강제로 다시 트리거
            // (이미 선택된 파일이 있다면, 그 파일 목록으로 handleNewImagePreview를 다시 호출)
            handleNewImagePreview({ target: imageInput });
        });
    });

});
</script>
{% endblock %}