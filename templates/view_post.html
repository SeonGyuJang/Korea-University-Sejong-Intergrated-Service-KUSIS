{% extends "base.html" %}

{% block title %}KUSIS - {{ post.title }}{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/view_post.css') }}">
<style>
    /* 카테고리 아이콘 스타일 */
    .post-category-icon {
        font-size: 1.1em; /* 제목 크기에 비례 */
        color: var(--korea-red-light);
        margin-right: 8px;
    }
    /* 수정 버튼 스타일 */
    .btn-edit-view {
        background: #3498db;
        color: white;
        border: 1px solid #3498db;
        margin-left: 10px; /* 목록 버튼과의 간격 */
    }
    .btn-edit-view:hover {
        background: #2980b9;
        border-color: #2980b9;
    }

    /* --- [신규] 이미지 갤러리 스타일 --- */
    .post-image-gallery {
        display: grid;
        /* 반응형 그리드: 최소 150px, 최대 1fr 크기의 열 자동 생성 */
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px; /* 이미지 간격 */
        margin-bottom: 30px; /* 갤러리와 본문 간격 */
    }

    .post-image-item {
        width: 100%;
        height: auto; /* 비율 유지 */
        max-height: 300px; /* 최대 높이 제한 (선택 사항) */
        object-fit: contain; /* 이미지가 잘리지 않도록 */
        border-radius: 8px; /* 모서리 약간 둥글게 */
        border: 1px solid var(--border-color);
        background: #f8f9fa; /* 로딩 배경 */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); /* 부드러운 그림자 */
    }
</style>
{% endblock %}

{% block content %}
<div class="content-area view-post-page">
    <div class="view-post-container">
        {# 제목과 버튼 영역 #}
        <header class="post-header">
            <div class="header-left">
                {% set category_icons = {'공지': 'fas fa-bullhorn', '홍보': 'fas fa-ad', '안내': 'fas fa-info-circle', '업데이트': 'fas fa-sync-alt', '일반': 'fas fa-comment-alt'} %}
                {% set icon_class = category_icons.get(post.category, category_icons['일반']) %}
                <i class="{{ icon_class }} post-category-icon" title="{{ post.category }}"></i>
                <h1 class="post-title">{{ post.title }}</h1>
            </div>
            {# 버튼 그룹 #}
            <div>
                <a href="{{ url_for('post_management') }}" class="btn btn-outline">
                    <i class="fas fa-list"></i> 목록으로
                </a>
                {# 수정 버튼 추가 (권한 확인) #}
                {% if user.is_admin or post.author_id == user.id %}
                <a href="{{ url_for('edit_post', post_id=post.id) }}" class="btn btn-outline btn-edit-view">
                    <i class="fas fa-edit"></i> 수정
                </a>
                {% endif %}
            </div>
        </header>

        {# 승인 상태 표시 #}
        {% if (not post.is_approved) and (user.is_admin or post.author_id == user.id) %}
        <div class="alert alert-warning post-approval-notice" role="alert">
            <i class="fas fa-clock"></i> 이 게시물은 현재 관리자 승인 대기 중입니다.
        </div>
        {% endif %}

        {# 메타 정보 #}
        <div class="post-meta">
            <span class="meta-item"><i class="fas fa-user"></i> 작성자: <strong>{{ post.author.name }}</strong></span>
            {# kst 필터 사용하여 KST로 표시 #}
            <span class="meta-item"><i class="fas fa-calendar-alt"></i> 작성일: <strong>{{ post.created_at | kst }}</strong> (KST)</span>
            {% if post.expires_at %}
                {# kst 필터 사용하여 KST로 표시 #}
                <span class="meta-item"><i class="far fa-calendar-times"></i> 노출 마감: <strong>{{ post.expires_at | kst }}</strong> (KST)</span>
            {% endif %}
        </div>

        {# 본문 컨텐츠 영역 #}
        <article class="post-body">
            {# --- [수정] 여러 이미지 표시 --- #}
            {% if image_filenames %}
            <div class="post-image-gallery">
                {% for filename in image_filenames %}
                <img src="{{ url_for('uploaded_file', filename=filename) }}" alt="{{ post.title }} 이미지 {{ loop.index }}" class="post-image-item">
                {% endfor %}
            </div>
            {% endif %}
            {# --- 수정 끝 --- #}

            <div class="post-content">
                {{ post.content | safe }} {# DB 저장 시 <br> 처리되었으므로 safe 필터 사용 #}
            </div>
        </article>
    </div>
</div>
{% endblock %}